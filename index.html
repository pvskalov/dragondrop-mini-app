<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DragonDrop App</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–µ–π -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ Inter –æ—Ç Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- –í—Å–µ CSS-—Å—Ç–∏–ª–∏ -->
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Ç–∫–∏, —á—Ç–æ–±—ã –æ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–ª–æ—Å—å */
        .duck-image {
            max-width: 150px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Ç–∫–∏ */
            height: auto;
        }
        /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏ */
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            color: #6b7280; /* –°–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
            font-size: 0.75rem; /* text-xs */
            transition: color 0.2s ease-in-out;
        }
        .bottom-nav-item.active {
            color: #007bff; /* –°–∏–Ω–∏–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
        }
        .bottom-nav-item i {
            font-size: 1.25rem; /* text-xl */
            margin-bottom: 4px;
        }
        /* –°–∫—Ä—ã—Ç—å –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;  /* –î–ª—è IE –∏ Edge */
            scrollbar-width: none;  /* –î–ª—è Firefox */
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞ */
        .size-button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb; /* gray-200 */
            background-color: #f9fafb; /* gray-50 */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .size-button.selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6;
        }
        .size-button:hover:not(.selected) {
            background-color: #e5e7eb; /* gray-200 */
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-size: 1.2rem;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- –í–ê–ñ–ù–û: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram WebApp SDK —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∫—ç—à-–±–∞—Å—Ç–µ—Ä–æ–º -->
    <script>
        const telegramWebAppScript = document.createElement('script');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Date.now() –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤–µ—Ä—Å–∏–∏, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –∫—ç—à
        telegramWebAppScript.src = `https://telegram.org/js/telegram-web-app.js?v=${Date.now()}`;
        document.head.appendChild(telegramWebAppScript);

        telegramWebAppScript.onload = () => {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready(); // –°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
                console.log("Telegram WebApp is ready.");

                if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                    const telegramUser = Telegram.WebApp.initDataUnsafe.user;
                    console.log("Telegram User Data (after ready):", telegramUser);
                    window.telegramUserData = telegramUser; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ
                } else {
                    console.warn("Telegram WebApp user data not available after ready(). initDataUnsafe:", Telegram.WebApp.initDataUnsafe ? Telegram.WebApp.initDataUnsafe : "Telegram.WebApp.initDataUnsafe is null/undefined");
                }
            } else {
                console.warn("Telegram WebApp object not found after script load.");
            }
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ alert()) -->
    <div id="messageBox" class="message-box"></div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app-content" class="flex-grow pb-20 overflow-y-auto">
        <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü —Å –ø–æ–º–æ—â—å—é JavaScript -->
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
        <div class="flex justify-around h-16 max-w-screen-md mx-auto">
            <button class="bottom-nav-item active" data-page="home">
                <i class="fas fa-home"></i>
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </button>
            <button class="bottom-nav-item" data-page="favorites">
                <i class="fas fa-heart"></i>
                <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
            </button>
            <button class="bottom-nav-item" data-page="cart">
                <i class="fas fa-shopping-cart"></i>
                <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
            </button>
            <button class="bottom-nav-item" data-page="friends">
                <i class="fas fa-users"></i>
                <span>–î—Ä—É–∑—å—è</span>
            </button>
            <button class="bottom-nav-item" data-page="settings">
                <i class="fas fa-cog"></i>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </button>
        </div>
    </nav>

    <!-- –í–µ—Å—å JavaScript-–∫–æ–¥ -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç—ã Firebase SDK (—Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // –í–∞–∂–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω—ã serverTimestamp –∏ increment –≤ –∏–º–ø–æ—Ä—Ç—ã Firestore
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let currentUserId = null;
        let isFirebaseReady = false;
        // –û–±—ä–µ–∫—Ç firestore —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç serverTimestamp –∏ increment
        const firestore = {
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, increment
        };
        const appId = "dragondropapp-9e6a6"; // –¢–≤–æ–π projectId –∫–∞–∫ appId –¥–ª—è Firestore –ø—É—Ç–∏

        let selectedProduct = null;
        let currentUserProfile = null;

        // –¢–í–û–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAs32uOlV5VugkioYbT-PvS-D0L-5IF_mE",
            authDomain: "dragondropapp-9e6a6.firebaseapp.com",
            projectId: "dragondropapp-9e6a6",
            storageBucket: "dragondropapp-9e6a6.firebasestorage.app",
            messagingSenderId: "106217738831",
            appId: "1:106217738831:web:be1b6433b3eae44ce0d03a"
        };

        // --- utils.js —Ñ—É–Ω–∫—Ü–∏–∏ (—Ç–µ–ø–µ—Ä—å –≤—Å—Ç—Ä–æ–µ–Ω—ã) ---
        function showMessage(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            } else {
                console.warn("–≠–ª–µ–º–µ–Ω—Ç #messageBox –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–æ–±—â–µ–Ω–∏–µ:", message);
            }
        }

        function showLoading(message = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.querySelector('p').textContent = message;
                loadingOverlay.classList.remove('hidden');
            } else {
                console.warn("–≠–ª–µ–º–µ–Ω—Ç #loadingOverlay –Ω–µ –Ω–∞–π–¥–µ–Ω.");
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            } else {
                console.warn("–≠–ª–µ–º–µ–Ω—Ç #loadingOverlay –Ω–µ –Ω–∞–π–¥–µ–Ω.");
            }
        }

        // --- api.js —Ñ—É–Ω–∫—Ü–∏–∏ (—Ç–µ–ø–µ—Ä—å –≤—Å—Ç—Ä–æ–µ–Ω—ã) ---
        const FETCH_POIZON_PRODUCT_FUNCTION_URL = 'http://localhost:3000/fetch-poizon-product';
        const TRACK_DOBROPOST_PARCEL_FUNCTION_URL = 'http://localhost:3000/track-dobropost-parcel';

        async function fetchPoizonProduct(link) {
            showLoading('–°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å Poizon...');
            try {
                console.log(`API: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ ${FETCH_POIZON_PRODUCT_FUNCTION_URL} —Å —Å—Å—ã–ª–∫–æ–π: ${link}`);
                const response = await fetch(FETCH_POIZON_PRODUCT_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ link: link }),
                });

                console.log("API: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –°—Ç–∞—Ç—É—Å:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API: –û—à–∏–±–∫–∞ HTTP: ${response.status} - ${errorText}`);
                    showMessage(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.`);
                    return null;
                }

                const result = await response.json();
                console.log("API: –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:", result);

                if (result.success) {
                    return result.product;
                } else {
                    showMessage(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å Poizon.');
                    console.error('API: –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–æ—Ç–≤–µ—Ç success: false):', result.error || result);
                    return null;
                }
            } catch (error) {
                showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
                console.error('API: –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', error);
                return null;
            } finally {
                hideLoading();
            }
        }

        async function trackDobropostParcel(trackingNumber) {
            showLoading('–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–æ—Å—ã–ª–∫—É...');
            try {
                console.log(`API: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ ${TRACK_DOBROPOST_PARCEL_FUNCTION_URL} —Å –Ω–æ–º–µ—Ä–æ–º: ${trackingNumber}`);
                const response = await fetch(TRACK_DOBROPOST_PARCEL_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ trackingNumber: trackingNumber }),
                });

                console.log("API: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –°—Ç–∞—Ç—É—Å:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API: –û—à–∏–±–∫–∞ HTTP: ${response.status} - ${errorText}`);
                    showMessage(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.`);
                    return null;
                }

                const result = await response.json();
                console.log("API: –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:", result);

                if (result.success) {
                    return result.trackingInfo;
                } else {
                    showMessage(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–∏ –ø–æ—Å—ã–ª–∫–∏.');
                    console.error('API: –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–æ—Ç–≤–µ—Ç success: false):', result.error || result);
                    return null;
                }
            } catch (error) {
                showMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
                console.error('API: –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', error);
                return null;
            } finally {
                hideLoading();
            }
        }

        // --- Firebase-related functions (—Ç–µ–ø–µ—Ä—å –≤—Å—Ç—Ä–æ–µ–Ω—ã) ---
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function getUserProfile(userId, invitedByCode = null) {
            console.log("getUserProfile: –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è userId:", userId, "isFirebaseReady:", isFirebaseReady);
            if (!userId) {
                console.error("getUserProfile: userId –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.");
                return null;
            }
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ db –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–π Firestore
            if (!db) {
                console.error("getUserProfile: Firestore DB –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, initFirebase –¥–æ–ª–∂–µ–Ω –±—ã–ª –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω —Ä–∞–Ω–µ–µ.");
                showMessage("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –≥–æ—Ç–æ–≤–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
                return null;
            }

            const userDocRef = firestore.doc(db, `artifacts/${appId}/users/${userId}`);
            try {
                const userDocSnap = await firestore.getDoc(userDocRef);
                console.log("getUserProfile: userDocSnap.exists() –¥–ª—è userId", userId, ":", userDocSnap.exists());

                if (userDocSnap.exists()) {
                    currentUserProfile = userDocSnap.data();
                    console.log("getUserProfile: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω:", currentUserProfile);
                    return currentUserProfile;
                } else {
                    console.log("getUserProfile: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π.");
                    const newUserProfile = {
                        balance: 0,
                        referralCode: generateReferralCode(),
                        createdAt: firestore.serverTimestamp(), // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ serverTimestamp
                        invitedBy: invitedByCode || null,
                        hasMadeFirstOrder: false
                    };

                    console.log("getUserProfile: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:", newUserProfile);
                    await firestore.setDoc(userDocRef, newUserProfile);
                    currentUserProfile = newUserProfile;
                    console.log("getUserProfile: –ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞–Ω:", currentUserProfile);
                    return currentUserProfile;
                }
            } catch (error) {
                console.error("getUserProfile: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏/—Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
                showMessage("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
                throw error; // –ü–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –≤—ã–∑—ã–≤–∞—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –º–æ–≥–ª–∞ –µ—ë –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
            }
        }

        async function updateUserBalance(userId, amount) {
            if (!userId) {
                console.error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å: userId –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω.");
                showMessage("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å.");
                return;
            }
            const userDocRef = firestore.doc(db, `artifacts/${appId}/users/${userId}`);
            try {
                await firestore.updateDoc(userDocRef, {
                    balance: firestore.increment(amount) // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ increment
                });
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã UI —Å—Ä–∞–∑—É –æ—Ç—Ä–∞–∑–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if (currentUserProfile && currentUserId === userId) { // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å currentUserId –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                     currentUserProfile.balance = (currentUserProfile.balance || 0) + amount;
                }
                showMessage(`–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${amount} ‚ÇΩ.`);
                console.log(`–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${amount}.`);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", userId, error);
                showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞.");
            }
        }

        async function initFirebase() {
            return new Promise(async (resolve, reject) => {
                console.log("Firebase: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...");
                console.log("Firebase Config:", firebaseConfig);

                if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId || !firebaseConfig.appId) {
                    console.error("Firebase: –ù–µ–ø–æ–ª–Ω–∞—è –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase.");
                    showMessage('–û—à–∏–±–∫–∞: –ù–µ–ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.');
                    isFirebaseReady = false;
                    reject(new Error("–ù–µ–ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase."));
                    return;
                }

                try {
                    firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);
                    console.log("Firebase: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Å–µ—Ä–≤–∏—Å—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.");

                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        let determinedUserId = null;
                        console.log("onAuthStateChanged: Callback triggered.");

                        // –ü–æ–ø—ã—Ç–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å userId —Å–Ω–∞—á–∞–ª–∞ –∏–∑ Telegram.WebApp
                        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                            determinedUserId = String(window.Telegram.WebApp.initDataUnsafe.user.id);
                            console.log("onAuthStateChanged: Telegram User ID –Ω–∞–π–¥–µ–Ω:", determinedUserId);
                        } else if (user) {
                            // –ï—Å–ª–∏ Telegram ID –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º Firebase Auth UID
                            determinedUserId = user.uid;
                            console.log("onAuthStateChanged: Firebase Auth UID –Ω–∞–π–¥–µ–Ω:", determinedUserId);
                        } else {
                            console.log("onAuthStateChanged: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É. –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...");
                            try {
                                if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                                    console.log("onAuthStateChanged: –û–±–Ω–∞—Ä—É–∂–µ–Ω initial_auth_token. –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Ç–æ–∫–µ–Ω–æ–º...");
                                    await signInWithCustomToken(auth, window.__initial_auth_token);
                                    console.log("onAuthStateChanged: –í—Ö–æ–¥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Ç–æ–∫–µ–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω.");
                                } else {
                                    console.log("onAuthStateChanged: initial_auth_token –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –≤—ã–ø–æ–ª–Ω–µ–Ω –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥.");
                                    await signInAnonymously(auth);
                                }
                                if (auth.currentUser) {
                                    determinedUserId = auth.currentUser.uid;
                                    console.log("onAuthStateChanged: UID –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞:", determinedUserId);
                                }
                            } catch (authError) {
                                console.error("onAuthStateChanged: –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (custom token –∏–ª–∏ –∞–Ω–æ–Ω–∏–º–Ω—ã–π):", authError);
                                // Fallback: –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å UID, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π
                                determinedUserId = 'temp_anon_' + Math.random().toString(36).substring(2, 15);
                                console.warn("onAuthStateChanged: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–π UID, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID:", determinedUserId);
                                showMessage('–í–Ω–∏–º–∞–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø—Ä–æ—Ñ–∏–ª—é. –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è.');
                            }
                        }

                        currentUserId = determinedUserId;
                        isFirebaseReady = true;
                        console.log("onAuthStateChanged: isFirebaseReady —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ true. –¢–µ–∫—É—â–∏–π UID –¥–ª—è Firestore:", currentUserId);

                        unsubscribe(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                        resolve();
                    });

                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                    showMessage('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                    isFirebaseReady = false;
                    reject(error);
                }
            });
        }

        // --- main.js —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ª–æ–≥–∏–∫–∞ (—Ç–µ–ø–µ—Ä—å –≤—Å—Ç—Ä–æ–µ–Ω—ã) ---
        function calculateFullPrice(basePriceYuan) {
            const yuanToRubRate = 12.5;
            const dragonDropCommissionRate = 0.10;
            const fixedCommission = 500;
            const chinaDelivery = 50;
            const internationalDeliveryPerKg = 1000;
            const itemWeightKg = 0.5;
            const priceInRubles = basePriceYuan * yuanToRubRate;
            const commission = Math.max(priceInRubles * dragonDropCommissionRate, fixedCommission);
            const chinaDeliveryRubles = chinaDelivery * yuanToRubRate;
            const internationalDeliveryRubles = internationalDeliveryPerKg * itemWeightKg;
            const russiaDelivery = 300;
            return priceInRubles + commission + chinaDeliveryRubles + internationalDeliveryRubles + russiaDelivery;
        }

        async function renderPage(pageName) {
            const appContent = document.getElementById('app-content');
            let content = '';
            let headerTitle = 'DragonDrop';

            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            const userBalance = currentUserProfile ? currentUserProfile.balance : 0;

            switch (pageName) {
                case 'home':
                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-2">
                                    <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                                        <i class="fas fa-times mr-1"></i> –ó–∞–∫—Ä—ã—Ç—å
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mb-4">
                                <h1 class="text-xl font-semibold">DragonDrop</h1>
                                <button class="px-4 py-2 bg-blue-500 text-white rounded-full text-sm font-medium">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                            <div class="mb-4">
                                <input type="text" placeholder="–ù–∞–π—Ç–∏ –∫—Ä–æ—Å—Å–æ–≤–∫–∏" class="w-full p-3 rounded-xl bg-gray-100 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <div class="bg-yellow-100 p-3 rounded-xl flex items-center justify-center text-center flex-col shadow-sm">
                                    <img src="https://placehold.co/80x80/FFD700/FFFFFF?text=–î—Ä—É–∑—å—è" alt="–ó–æ–≤–∏ –¥—Ä—É–∑–µ–π" class="rounded-full mb-2">
                                    <p class="text-sm font-medium">–ó–æ–≤–∏ –¥—Ä—É–∑–µ–π! +500‚ÇΩ</p>
                                </div>
                                <div class="bg-purple-100 p-3 rounded-xl flex items-center justify-center text-center flex-col shadow-sm">
                                    <img src="https://placehold.co/80x80/8A2BE2/FFFFFF?text=Dragon" alt="–ß—Ç–æ —É–º–µ–µ—Ç DragonDrop" class="rounded-full mb-2">
                                    <p class="text-sm font-medium">–ß—Ç–æ —É–º–µ–µ—Ç DragonDrop?</p>
                                </div>
                                <div class="bg-gray-100 p-3 rounded-xl flex items-center justify-center text-center flex-col shadow-sm">
                                    <img src="https://placehold.co/80x80/A9A9A9/FFFFFF?text=–ó–∞–∫–∞–∑" alt="3 —Å–ø–æ—Å–æ–±–∞ –∑–∞–∫–∞–∑–∞—Ç—å" class="rounded-full mb-2">
                                    <p class="text-sm font-medium">3 —Å–ø–æ—Å–æ–±–∞ –∑–∞–∫–∞–∑–∞—Ç—å –∫—Ä–æ—Å—Å–æ–≤–∫–∏</p>
                                </div>
                                <div class="bg-red-100 p-3 rounded-xl flex items-center justify-center text-center flex-col shadow-sm">
                                    <img src="https://placehold.co/80x80/FF0000/FFFFFF?text=–°–∫–∏–¥–∫–∞" alt="–ó–∞–∫–∞–∑—ã–≤–∞–π —Å–µ–π—á–∞—Å" class="rounded-full mb-2">
                                    <p class="text-sm font-medium">–ó–∞–∫–∞–∑—ã–≤–∞–π —Å–µ–π—á–∞—Å –ø–ª–∞—Ç–∏ –ø–æ—Ç–æ–º 50%</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-red-500 text-white p-4 rounded-xl flex flex-col justify-between shadow-md">
                                    <p class="text-sm font-medium">–ë–∞–ª–ª—ã</p>
                                    <p class="text-3xl font-bold">‚ÇΩ ${userBalance}</p>
                                </div>
                                <div class="bg-blue-500 text-white p-4 rounded-xl flex flex-col justify-between items-end text-right shadow-md">
                                    <p class="text-sm font-medium">–í—ã–±—Ä–∞—Ç—å –∏ –∑–∞–∫–∞–∑–∞—Ç—å</p>
                                    <i class="fas fa-arrow-right text-3xl mt-2"></i>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                                <div class="flex items-center justify-between cursor-pointer" id="calculate-cost-link">
                                    <div class="flex items-center space-x-3">
                                        <img src="https://placehold.co/40x40/000000/FFFFFF?text=P" alt="Poizon logo" class="rounded-full">
                                        <p class="font-medium">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ –∏–∑ Poizon</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-semibold text-lg">–õ—É–∫–±—É–∫ 2025</h3>
                                    <span class="text-blue-500 text-sm cursor-pointer">–í—Å–µ ></span>
                                    </div>
                                <div class="grid grid-cols-3 gap-2 mt-4">
                                    <img src="https://placehold.co/100x100/E0BBE4/FFFFFF?text=–û–±—Ä–∞–∑1" alt="–û–±—Ä–∞–∑ 1" class="rounded-lg w-full h-auto object-cover">
                                    <img src="https://placehold.co/100x100/957DAD/FFFFFF?text=–û–±—Ä–∞–∑2" alt="–û–±—Ä–∞–∑ 2" class="rounded-lg w-full h-auto object-cover">
                                    <img src="https://placehold.co/100x100/D291BC/FFFFFF?text=–û–±—Ä–∞–∑3" alt="–û–±—Ä–∞–∑ 3" class="rounded-lg w-full h-auto object-cover">
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'favorites':
                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="home">
                                    <i class="fas fa-times mr-1"></i> –ó–∞–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                            <div class="flex flex-col items-center justify-center py-10">
                                <img src="https://placehold.co/150x150/FFD700/FFFFFF?text=ü¶Ü" alt="–£—Ç–∫–∞" class="duck-image mb-6">
                                <h2 class="text-2xl font-bold mb-2 text-center">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</h2>
                                <p class="text-gray-600 text-center max-w-xs">–ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–∏ —Ä—è–¥–æ–º —Å —Ç–æ–≤–∞—Ä–∞–º–∏, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å —Ç–æ, —á—Ç–æ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å.</p>
                            </div>
                            <div class="mt-8 text-center text-gray-500">
                                <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã.</p>
                                <p>–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å –±—ç–∫–µ–Ω–¥–∞.</p>
                            </div>
                        </div>
                    `;
                    break;

                case 'cart':
                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="home">
                                    <i class="fas fa-times mr-1"></i> –ó–∞–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                            <div class="flex flex-col items-center justify-center py-10">
                                <img src="https://placehold.co/150x150/FFD700/FFFFFF?text=ü¶Ü" alt="–£—Ç–∫–∞" class="duck-image mb-6">
                                <h2 class="text-2xl font-bold mb-2 text-center">–ö–æ—Ä–∑–∏–Ω–∞</h2>
                                <p class="text-gray-600 text-center max-w-xs">–í –∫–æ—Ä–∑–∏–Ω–µ –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç. –°–∞–º–æ–µ –≤—Ä–µ–º—è –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –µ–µ!</p>
                            </div>
                            <div class="mt-8 text-center text-gray-500">
                                <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–æ–≤–∞—Ä—ã –≤ –≤–∞—à–µ–π –∫–æ—Ä–∑–∏–Ω–µ.</p>
                                <p>–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å –±—ç–∫–µ–Ω–¥–∞.</p>
                            </div>
                        </div>
                    `;
                    break;

                case 'friends':
                    // STEP 1: Ensure Firebase is ready and we have a currentUserId
                    if (!isFirebaseReady || !currentUserId) {
                        showLoading('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                        try {
                            await initFirebase(); // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω–µ –≥–æ—Ç–æ–≤
                            if (!currentUserId) { // –ï—Å–ª–∏ UID –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                                content = `
                                    <div class="p-4 bg-white rounded-b-xl shadow-sm">
                                        <div class="flex items-center justify-between mb-4">
                                            <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="home">
                                                <i class="fas fa-times mr-1"></i> –ó–∞–∫—Ä—ã—Ç—å
                                            </button>
                                        </div>
                                        <div class="flex flex-col items-center justify-center py-10">
                                            <img src="https://placehold.co/150x150/FFD700/FFFFFF?text=ü¶Ü" alt="–£—Ç–∫–∞" class="duck-image mb-6">
                                            <h2 class="text-2xl font-bold mb-2 text-center">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</h2>
                                            <p class="text-gray-600 text-center max-w-xs mb-4">–î—Ä—É–≥ –ø–æ–ª—É—á–∏—Ç 500‚ÇΩ —Å—Ä–∞–∑—É, –∞ —Ç—ã –ø–æ–ª—É—á–∏—à—å 500‚ÇΩ, –∫–æ–≥–¥–∞ –¥—Ä—É–≥ —Å–¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</p>
                                            <div class="bg-gray-100 p-3 rounded-xl w-full max-w-sm flex flex-col items-center mb-6 shadow-inner">
                                                <p class="text-sm text-gray-600">–¢–≤–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:</p>
                                                <p class="font-bold text-xl text-blue-600">–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>
                                                <p class="text-red-500 text-sm">–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
                                            </div>
                                        </div>
                                        <div class="p-4">
                                            <button class="w-full bg-pink-500 text-white py-3 rounded-xl text-lg font-semibold shadow-md" id="share-referral-btn">
                                                –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞ 500 ‚ÇΩ
                                            </button>
                                        </div>
                                    </div>
                                `;
                                hideLoading();
                                break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ switch
                            }
                        } catch (e) {
                            console.error("renderPage('friends'): –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
                            showMessage("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å.");
                            hideLoading();
                            break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ switch
                        } finally {
                            hideLoading(); // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        }
                    }

                    // STEP 2: –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ currentUserId –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    if (!currentUserProfile) {
                        showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...');
                        try {
                            await getUserProfile(currentUserId);
                        } catch (e) {
                            console.error("renderPage('friends'): –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ/—Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:", e);
                            showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å.");
                        } finally {
                            hideLoading();
                        }
                    }

                    // STEP 3: –†–µ–Ω–¥–µ—Ä–∏–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
                    if (!currentUserProfile || !currentUserProfile.referralCode) {
                        content = `
                            <div class="p-4 bg-white rounded-b-xl shadow-sm">
                                <div class="flex items-center justify-between mb-4">
                                    <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="home">
                                        <i class="fas fa-times mr-1"></i> –ó–∞–∫—Ä—ã—Ç—å
                                    </button>
                                </div>
                                <div class="flex flex-col items-center justify-center py-10">
                                    <img src="https://placehold.co/150x150/FFD700/FFFFFF?text=ü¶Ü" alt="–£—Ç–∫–∞" class="duck-image mb-6">
                                    <h2 class="text-2xl font-bold mb-2 text-center">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</h2>
                                    <p class="text-gray-600 text-center max-w-xs mb-4">–î—Ä—É–≥ –ø–æ–ª—É—á–∏—Ç 500‚ÇΩ —Å—Ä–∞–∑—É, –∞ —Ç—ã –ø–æ–ª—É—á–∏—à—å 500‚ÇΩ, –∫–æ–≥–¥–∞ –¥—Ä—É–≥ —Å–¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</p>
                                    <div class="bg-gray-100 p-3 rounded-xl w-full max-w-sm flex flex-col items-center mb-6 shadow-inner">
                                        <p class="text-sm text-gray-600">–¢–≤–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:</p>
                                        <p class="font-bold text-xl text-blue-600">–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>
                                        <p class="text-red-500 text-sm">–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</p>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <button class="w-full bg-pink-500 text-white py-3 rounded-xl text-lg font-semibold shadow-md" id="share-referral-btn">
                                        –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞ 500 ‚ÇΩ
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        const referralCode = currentUserProfile.referralCode;
                        const botUsername = 'dragondrop_poizon_bot'; // –ò–º—è —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞
                        const referralLink = `https://t.me/${botUsername}?start=${referralCode}`;

                        content = `
                            <div class="p-4 bg-white rounded-b-xl shadow-sm">
                                <div class="flex items-center justify-between mb-4">
                                    <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="home">
                                        <i class="fas fa-times mr-1"></i> –ó–∞–∫—Ä—ã—Ç—å
                                    </button>
                                </div>
                                <div class="flex flex-col items-center justify-center py-10">
                                    <img src="https://placehold.co/150x150/FFD700/FFFFFF?text=ü¶Ü" alt="–£—Ç–∫–∞" class="duck-image mb-6">
                                    <h2 class="text-2xl font-bold mb-2 text-center">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</h2>
                                    <p class="text-gray-600 text-center max-w-xs mb-4">–î—Ä—É–≥ –ø–æ–ª—É—á–∏—Ç 500‚ÇΩ —Å—Ä–∞–∑—É, –∞ —Ç—ã –ø–æ–ª—É—á–∏—à—å 500‚ÇΩ, –∫–æ–≥–¥–∞ –¥—Ä—É–≥ —Å–¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</p>
                                    <div class="bg-gray-100 p-3 rounded-xl w-full max-w-sm flex flex-col items-center mb-6 shadow-inner">
                                        <p class="text-sm text-gray-600">–¢–≤–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:</p>
                                        <p class="font-bold text-xl text-blue-600">${referralCode}</p>
                                        <p class="text-sm text-gray-600 mt-2">–ò–ª–∏ –ø–æ–¥–µ–ª–∏—Å—å —Å—Å—ã–ª–∫–æ–π:</p>
                                        <a href="${referralLink}" target="_blank" class="text-blue-500 text-sm break-all text-center mt-1">${referralLink}</a>
                                        <button id="copy-referral-link-btn" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg text-sm font-semibold">
                                            –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                                        </button>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <button class="w-full bg-pink-500 text-white py-3 rounded-xl text-lg font-semibold shadow-md" id="share-referral-btn">
                                        –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞ 500 ‚ÇΩ
                                    </button>
                                </div>
                                <div class="mt-8 text-center text-gray-500">
                                    <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã.</p>
                                    <p>–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å –±—ç–∫–µ–Ω–¥–∞.</p>
                                </div>
                            </div>
                        `;
                    }
                    break;

                case 'settings':
                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="home">
                                    <i class="fas fa-times mr-1"></i> –ó–∞–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                            <div class="flex flex-col items-center py-6">
                                <img id="profile-avatar" src="https://placehold.co/100x100/A0D9B1/FFFFFF?text=–ê–Ω–¥—Ä–µ–π" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" class="w-24 h-24 rounded-full object-cover mb-4 shadow-md">
                                <h2 id="profile-name" class="text-2xl font-bold mb-6">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                            </div>

                            <div class="space-y-4 mb-6">
                                <div class="flex items-center bg-gray-100 p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-plus-circle text-blue-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-user text-red-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-lock text-gray-600 mr-3 text-lg"></i>
                                    <span class="flex-grow">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-star text-yellow-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–°—Ç–∞—Ç—É—Å</span>
                                    <span class="text-gray-500 mr-2">–ù–æ–≤–∏—á–æ–∫</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-wallet text-green-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–ë–∞–ª–∞–Ω—Å</span>
                                    <span class="text-gray-500 mr-2">${userBalance} ‚ÇΩ</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-user-plus text-blue-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</span>
                                    <span class="text-gray-500 mr-2">+500 ‚ÇΩ</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm cursor-pointer" id="my-orders-link">
                                    <i class="fas fa-box text-red-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–ó–∞–∫–∞–∑—ã</span>
                                    <span class="text-gray-500 mr-2">1</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-comment-alt text-orange-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–û—Ç–∑—ã–≤—ã</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-heart text-pink-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-th-large text-purple-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–ü–æ–¥–±–æ—Ä–∫–∏</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                                <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                                    <i class="fas fa-eye text-blue-500 mr-3 text-lg"></i>
                                    <span class="flex-grow">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</span>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </div>
                            <div class="mt-8 text-center text-gray-500">
                                <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å –±—ç–∫–µ–Ω–¥–∞.</p>
                            </div>
                        </div>
                    `;
                    break;

                case 'calculateCostInfo':
                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm flex flex-col min-h-[calc(100vh-4rem)]">
                            <div class="flex items-center justify-between mb-4">
                                <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="home">
                                    <i class="fas fa-chevron-left mr-1"></i> –ù–∞–∑–∞–¥
                                </button>
                            </div>
                            <div class="flex items-center mb-6">
                                <img src="https://placehold.co/60x60/000000/FFFFFF?text=ÂæóÁâ©" alt="Poizon logo" class="rounded-lg mr-4">
                                <div>
                                    <h2 class="text-xl font-semibold">Poizon (De Wu)</h2>
                                    <p class="text-gray-600 text-sm">–ö–∏—Ç–∞–π—Å–∫–∏–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</p>
                                </div>
                            </div>
                            <button class="w-full bg-blue-500 text-white py-2 rounded-xl text-md font-medium mb-8">
                                –û—Ç–∫—Ä—ã—Ç—å –≤ AppStore
                            </button>

                            <h3 class="text-xl font-bold mb-4">–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h3>
                            <p class="text-gray-700 mb-4">
                                –†–∞—Å—Å—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞ –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ Poizon, –≤–∫–ª—é—á–∞—è –Ω–∞—à—É –∫–æ–º–∏—Å—Å–∏—é –∏ –¥–æ—Å—Ç–∞–≤–∫—É.
                            </p>
                            <p class="text-gray-700 mb-4">
                                –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—â–µ –Ω–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Poizon ‚Äî —Å–∫–∞—á–∏–≤–∞–π –ø–æ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ. –¢–∞–º –µ—Å—Ç—å –ª—é–±—ã–µ –∫—Ä–æ—Å—Å–æ–≤–∫–∏ –∏ –≤–µ—â–∏, –¥–µ—à–µ–≤–ª–µ –Ω–∞ 30-50% —á–µ–º –≤ –†–§.
                            </p>
                            <p class="text-gray-700 mb-6">
                                –ê –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –∑–∞–º–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è ‚Äî —Å–∫–∏–¥—ã–≤–∞–π —Å—Å—ã–ª–∫—É –Ω–∞ Poizon –≤ —á–∞—Ç, –º—ã —Ç–µ–±–µ —Å–∫–∏–Ω–µ–º –≤ –æ—Ç–≤–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä.
                            </p>
                            <a href="#" class="text-blue-500 text-sm mb-auto">–ö–∞–∫ —Å–∫–∞—á–∞—Ç—å –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ Poizon?</a>

                            <button class="w-full bg-blue-500 text-white py-3 rounded-xl text-lg font-semibold shadow-md mt-8" id="start-calculate-button">
                                –ù–∞—á–∞—Ç—å
                            </button>
                        </div>
                    `;
                    break;

                case 'calculateCostInputLink':
                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm flex flex-col min-h-[calc(100vh-4rem)]">
                            <div class="flex items-center justify-between mb-4">
                                <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="calculateCostInfo">
                                    <i class="fas fa-chevron-left mr-1"></i> –ù–∞–∑–∞–¥
                                </button>
                            </div>
                            <p class="text-gray-700 mb-6">
                                –®–∞–≥ 1 –∏–∑ 3: –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–æ–≤–∞—Ä–µ –≤ Poizon –∫–Ω–æ–ø–∫—É ¬´–ø–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞. <a href="#" class="text-blue-500">–ê –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å?</a>
                            </p>
                            <div class="flex justify-center mb-8">
                                <img src="https://placehold.co/250x150/E0BBE4/FFFFFF?text=–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è" alt="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—é —Å—Å—ã–ª–∫–∏" class="rounded-lg shadow-md">
                            </div>
                            <div class="mb-auto">
                                <input type="url" id="poizon-link-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä Poizon" class="w-full p-3 rounded-xl bg-gray-100 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                            <button id="next-step-btn" class="w-full bg-blue-500 text-white py-3 rounded-xl text-lg font-semibold shadow-md mt-8">
                                –î–∞–ª–µ–µ
                            </button>
                        </div>
                    `;
                    break;

                case 'calculateCostProductDetails':
                    const product = selectedProduct;
                    if (!product) {
                        showMessage('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                        renderPage('calculateCostInputLink');
                        return;
                    }

                    const price29_35 = product.estimatedPriceRub ? product.estimatedPriceRub : 10924;
                    const price17_21 = product.estimatedPriceRub ? product.estimatedPriceRub + 1000 : 11924;

                    const imageUrl = product.imageUrl || "https://placehold.co/250x250/CCCCCC/FFFFFF?text=–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ+–Ω–µ+–Ω–∞–π–¥–µ–Ω–æ";
                    const productName = product.name || "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
                    const availableSizesHtml = product.availableSizes && product.availableSizes.length > 0
                        ? product.availableSizes.map(size => `
                            <button class="size-button ${size === product.selectedSize ? 'selected' : ''}" data-size="${size}">
                                ${size}
                            </button>
                        `).join('')
                        : '<p class="text-gray-500">–†–∞–∑–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';

                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm flex flex-col min-h-[calc(100vh-4rem)]">
                            <div class="flex items-center justify-between mb-4">
                                <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="calculateCostInputLink">
                                    <i class="fas fa-chevron-left mr-1"></i> –ù–∞–∑–∞–¥
                                </button>
                            </div>
                            <div class="flex flex-col items-center mb-6">
                                <img src="${imageUrl}" alt="${productName}" class="w-full max-w-xs rounded-lg shadow-md mb-4">
                                <p class="text-sm text-green-600 font-semibold mb-2"><i class="fas fa-check-circle mr-1"></i> –û—Ä–∏–≥–∏–Ω–∞–ª</p>
                                <h2 class="text-xl font-bold text-center mb-2">${productName}</h2>
                                <div class="flex flex-wrap justify-center gap-2 text-sm text-gray-600 mb-4">
                                    <span class="bg-gray-100 px-2 py-1 rounded-full">–û–±—É–≤—å</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded-full">–û–±—É–≤—å –¥–ª—è —Å–ø–æ—Ä—Ç–∞</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded-full">–ë–µ–≥</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 w-full max-w-xs mb-6">
                                    <div class="text-center">
                                        <p class="text-gray-500 text-sm">–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</p>
                                        <p class="font-medium">–ê–º–æ—Ä—Ç–∏–∑–∏—Ä—É—é—â–∏–µ, –∏–∑–Ω–æ—Å–æ—Å—Ç–æ–π–∫–∏–µ</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-gray-500 text-sm">–ü–æ—Å–∞–¥–∫–∞</p>
                                    <p class="font-medium">–£–Ω–∏—Å–µ–∫—Å</p>
                                    </div>
                                    <div class="col-span-2 text-center">
                                        <p class="text-gray-500 text-sm">–°–µ–∑–æ–Ω</p>
                                        <p class="font-medium">–í–µ—Å–Ω–∞, –ª–µ—Ç–æ, –æ—Å–µ–Ω—å</p>
                                    </div>
                                </div>

                                <div class="w-full max-w-xs mb-6">
                                    <p class="text-gray-700 text-sm font-bold mb-2">EU</p>
                                    <div id="size-selection" class="flex flex-wrap gap-2">
                                        ${availableSizesHtml}
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4 w-full max-w-xs mb-6">
                                    <div class="bg-blue-100 p-3 rounded-xl text-center">
                                        <p class="text-xl font-bold text-blue-700">${price29_35.toFixed(0)} ‚ÇΩ</p>
                                        <p class="text-sm text-blue-600">29-35 –¥–Ω–µ–π</p>
                                    </div>
                                    <div class="bg-blue-100 p-3 rounded-xl text-center">
                                        <p class="text-xl font-bold text-blue-700">${(price17_21).toFixed(0)} ‚ÇΩ</p>
                                        <p class="text-sm text-blue-600">17-21 –¥–µ–Ω—å</p>
                                    </div>
                                </div>

                                <p class="text-gray-600 text-sm text-center mb-4">
                                    –≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å, –µ—Å–ª–∏ –æ–Ω –≤–∞–º –Ω–µ –ø–æ–¥–æ–π–¥–µ—Ç. <a href="#" class="text-blue-500">–ö–∞–∫ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–≤–∞—Ä?</a>
                                </p>
                                <p class="text-gray-600 text-sm text-center mb-6">
                                    –°—Ä–æ–∫ —É–∫–∞–∑–∞–Ω –¥–ª—è –ú–æ—Å–∫–≤—ã, –ø–æ –†–æ—Å—Å–∏–∏ ‚Äî –¥–æ–ª—å—à–µ
                                </p>
                            </div>
                            <button id="buy-button" class="w-full bg-blue-500 text-white py-3 rounded-xl text-lg font-semibold shadow-md mt-auto">
                                –ö—É–ø–∏—Ç—å ${price29_35.toFixed(0)} ‚ÇΩ
                            </button>
                        </div>
                    `;
                    break;

                case 'orderConfirmation':
                    const orderProduct = selectedProduct;
                    if (!orderProduct) {
                        showMessage('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
                        renderPage('home');
                        return;
                    }

                    const orderPrice = orderProduct.estimatedPriceRub ? orderProduct.estimatedPriceRub : 10924;

                    const orderImageUrl = orderProduct.imageUrl || "https://placehold.co/250x250/CCCCCC/FFFFFF?text=–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ+–Ω–µ+–Ω–∞–π–¥–µ–Ω–æ";
                    const orderProductName = orderProduct.name || "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
                    const orderAvailableSizesHtml = orderProduct.availableSizes && orderProduct.availableSizes.length > 0
                        ? orderProduct.availableSizes.map(size => `
                            <button class="size-button ${size === orderProduct.selectedSize ? 'selected' : ''}" data-size="${size}">
                                ${size}
                            </button>
                        `).join('')
                        : '<p class="text-gray-500">–†–∞–∑–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';

                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm flex flex-col min-h-[calc(100vh-4rem)]">
                            <div class="flex items-center justify-between mb-4">
                                <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="calculateCostProductDetails">
                                    <i class="fas fa-chevron-left mr-1"></i> –ù–∞–∑–∞–¥
                                </button>
                            </div>
                            <div class="flex items-center mb-6">
                                <img src="${orderImageUrl}" alt="${orderProductName}" class="w-24 h-24 rounded-lg mr-4 shadow-md">
                                <div>
                                    <h2 class="text-lg font-bold">${orderProductName}</h2>
                                    <p class="text-sm text-green-600 font-semibold"><i class="fas fa-check-circle mr-1"></i> –û—Ä–∏–≥–∏–Ω–∞–ª</p>
                                    <p class="text-gray-600 text-sm">–†–∞–∑–º–µ—Ä: EU ${orderProduct.selectedSize || '–ù–µ –≤—ã–±—Ä–∞–Ω'}</p>
                                </div>
                            </div>

                            <div class="w-full mb-6">
                                <p class="text-gray-700 text-sm font-bold mb-2">EU</p>
                                <div id="order-size-selection" class="flex flex-wrap gap-2">
                                    ${orderAvailableSizesHtml}
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 w-full mb-6">
                                <div class="bg-blue-100 p-3 rounded-xl text-center">
                                    <p class="text-xl font-bold text-blue-700">${orderPrice.toFixed(0)} ‚ÇΩ</p>
                                    <p class="text-sm text-blue-600">29-35 –¥–Ω–µ–π</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-xl text-center">
                                    <p class="text-xl font-bold text-blue-700">${(orderPrice + 1000).toFixed(0)} ‚ÇΩ</p>
                                    <p class="text-sm text-blue-600">17-21 –¥–µ–Ω—å</p>
                                </div>
                            </div>

                            <h3 class="text-lg font-bold mb-3">–ö–∞–∫ –ø–æ–ª—É—á–∞—Ç—å</h3>
                            <div id="delivery-method-selection" class="flex bg-gray-100 rounded-xl p-1 mb-4">
                                <button class="flex-1 py-2 rounded-lg bg-white shadow-sm font-medium" data-method="–í –º–∞–≥–∞–∑–∏–Ω–µ">–í –º–∞–≥–∞–∑–∏–Ω–µ</button>
                                <button class="flex-1 py-2 rounded-lg font-medium" data-method="–í –ø—É–Ω–∫—Ç–µ –≤—ã–¥–∞—á–∏">–í –ø—É–Ω–∫—Ç–µ –≤—ã–¥–∞—á–∏</button>
                                <button class="flex-1 py-2 rounded-lg font-medium" data-method="–ö—É—Ä—å–µ—Ä–æ–º">–ö—É—Ä—å–µ—Ä–æ–º</button>
                            </div>
                            <p class="text-gray-700 mb-4">–°–µ—Ä–≥–∏–µ–≤ –ü–æ—Å–∞–¥, –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è —É–ª, –¥.20</p>

                            <h3 class="text-lg font-bold mb-3">–ö–æ–º—É –≤—ã–¥–∞—Ç—å</h3>
                            <p class="text-gray-700 mb-2">–ê–Ω–¥—Ä–µ–π –ü–∞—Å–∫–∞–ª–æ–≤</p>
                            <p class="text-700 mb-4">+7 (910) 776 11 86</p>

                            <div class="flex justify-between gap-4 mb-6">
                                <button class="flex-1 bg-green-100 text-green-700 py-2 rounded-xl font-semibold" id="add-points-btn">+50 –±–∞–ª–ª–æ–≤ –ù–∞—á–∏—Å–ª–∏—Ç—å</button>
                                <button class="flex-1 bg-red-100 text-red-700 py-2 rounded-xl font-semibold" id="subtract-points-btn">-50 –±–∞–ª–ª–æ–≤ –°–ø–∏—Å–∞—Ç—å</button>
                            </div>

                            <div class="flex items-center justify-between bg-gray-100 p-3 rounded-xl mb-6">
                                <p class="font-medium">–°–ø–ª–∏—Ç: –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–ª–æ–≤–∏–Ω—É —Å–µ–π—á–∞—Å, –ø–æ–ª–æ–≤–∏–Ω—É –ø–æ–∑–∂–µ</p>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <button id="place-order-btn" class="w-full bg-blue-500 text-white py-3 rounded-xl text-lg font-semibold shadow-md mt-auto">
                                –ó–∞–∫–∞–∑–∞—Ç—å ${orderPrice.toFixed(0)} ‚ÇΩ
                            </button>
                        </div>
                    `;
                    break;

                case 'myOrders':
                    content = `
                        <div class="p-4 bg-white rounded-b-xl shadow-sm flex flex-col min-h-[calc(100vh-4rem)]">
                            <div class="flex items-center justify-between mb-4">
                                <button class="flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm back-button" data-target-page="settings">
                                    <i class="fas fa-chevron-left mr-1"></i> –ù–∞–∑–∞–¥
                                </button>
                            </div>
                            <h2 class="text-2xl font-bold mb-6 text-center">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                            <div id="orders-list" class="space-y-4 mb-auto">
                                <p class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
                            </div>
                            <div class="mt-8 text-center text-gray-500">
                                <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å –±—ç–∫–µ–Ω–¥–∞.</p>
                            </div>
                        </div>
                    `;
                    break;

                default:
                    content = '<div class="p-4 text-center text-gray-500">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</div>';
                    break;
            }

            appContent.innerHTML = content;

            // --- –ü–†–ò–ö–†–ï–ü–õ–ï–ù–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô –ü–û–°–õ–ï –†–ï–ù–î–ï–†–ò–ù–ì–ê –°–¢–†–ê–ù–ò–¶–´ ---

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ù–∞–∑–∞–¥" (back-button)
            document.querySelectorAll('.back-button').forEach(button => {
                button.addEventListener('click', () => {
                    renderPage(button.dataset.targetPage);
                });
            });

            if (pageName === 'home') {
                const calculateCostLink = document.getElementById('calculate-cost-link');
                if (calculateCostLink) {
                    calculateCostLink.addEventListener('click', () => {
                        renderPage('calculateCostInfo');
                    });
                }
            }

            if (pageName === 'friends') {
                const copyReferralLinkBtn = document.getElementById('copy-referral-link-btn');
                if (copyReferralLinkBtn) {
                    const referralCode = currentUserProfile ? currentUserProfile.referralCode : '';
                    const botUsername = 'dragondrop_poizon_bot'; // –ò–º—è —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞
                    const referralLink = `https://t.me/${botUsername}?start=${referralCode}`;

                    copyReferralLinkBtn.addEventListener('click', async () => {
                        try {
                            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Navigator API –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                await navigator.clipboard.writeText(referralLink);
                                showMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                            } else {
                                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ –∏–ª–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–π –±–µ–∑ Clipboard API
                                const tempInput = document.createElement('textarea');
                                tempInput.value = referralLink;
                                document.body.appendChild(tempInput);
                                tempInput.select();
                                document.execCommand('copy');
                                document.body.removeChild(tempInput);
                                showMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                            }
                        } catch (err) {
                            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É:', err);
                            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏.');
                        }
                    });
                }

                const shareReferralBtn = document.getElementById('share-referral-btn');
                if (shareReferralBtn && window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.shareViaUrl) {
                    const referralCode = currentUserProfile ? currentUserProfile.referralCode : '';
                    const botUsername = 'dragondrop_poizon_bot'; // –ò–º—è —Ç–≤–æ–µ–≥–æ –±–æ—Ç–∞
                    const referralLink = `https://t.me/${botUsername}?start=${referralCode}`;
                    const shareText = `–ü—Ä–∏–≤–µ—Ç! –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ DragonDrop –∏ –∑–∞–∫–∞–∑—ã–≤–∞–π –∫—Ä–æ—Å—Å–æ–≤–∫–∏ –∏–∑ Poizon –¥–µ—à–µ–≤–ª–µ!\n–ò—Å–ø–æ–ª—å–∑—É–π –º–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: ${referralCode} –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ: ${referralLink}`;

                    shareReferralBtn.addEventListener('click', () => {
                        window.Telegram.WebApp.shareViaUrl({
                            url: referralLink,
                            text: shareText
                        });
                    });
                } else if (shareReferralBtn) {
                    shareReferralBtn.addEventListener('click', () => {
                        showMessage('–§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ Telegram. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é.');
                    });
                }
            }


            if (pageName === 'settings') {
                const profileNameElement = document.getElementById('profile-name');
                const profileAvatarElement = document.getElementById('profile-avatar');
                const myOrdersLink = document.getElementById('my-orders-link');

                if (myOrdersLink) {
                    myOrdersLink.addEventListener('click', () => {
                        renderPage('myOrders');
                    });
                }

                console.log("Telegram WebApp object:", window.Telegram);
                console.log("Telegram WebApp initDataUnsafe:", window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp.initDataUnsafe : "not available or Telegram.WebApp not initialized");

                if (window.telegramUserData) {
                    const telegramUser = window.telegramUserData;
                    let displayName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

                    console.log("Rendering Settings: Telegram User Data:", telegramUser);

                    if (telegramUser.first_name && telegramUser.last_name) {
                        displayName = `${telegramUser.first_name} ${telegramUser.last_name}`;
                    } else if (telegramUser.first_name) {
                        displayName = telegramUser.first_name;
                    } else if (telegramUser.username) {
                        displayName = `@${telegramUser.username}`;
                    }

                    if (profileNameElement) {
                        profileNameElement.textContent = displayName;
                    }

                    if (profileAvatarElement) {
                        if (telegramUser.photo_url) {
                            profileAvatarElement.src = telegramUser.photo_url;
                            profileAvatarElement.alt = `–ê–≤–∞—Ç–∞—Ä ${displayName}`;
                        } else {
                            profileAvatarElement.src = "https://placehold.co/100x100/A0D9B1/FFFFFF?text=TG";
                            profileAvatarElement.alt = "–ê–≤–∞—Ç–∞—Ä Telegram";
                        }
                    }
                } else {
                    console.warn("Rendering Settings: Telegram user data not available from global storage. Using default.");
                    if (profileNameElement) {
                        profileNameElement.textContent = "–ì–æ—Å—Ç—å";
                    }
                    if (profileAvatarElement) {
                        profileAvatarElement.src = "https://placehold.co/100x100/A0D9B1/FFFFFF?text=–ê–Ω–¥—Ä–µ–π";
                        profileAvatarElement.alt = "–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é";
                    }
                }
            }

            if (pageName === 'calculateCostInfo') {
                const startButton = document.getElementById('start-calculate-button');
                if (startButton) {
                    startButton.addEventListener('click', () => {
                        renderPage('calculateCostInputLink');
                    });
                }
            }

            if (pageName === 'calculateCostInputLink') {
                const nextStepBtn = document.getElementById('next-step-btn');
                if (nextStepBtn) {
                    nextStepBtn.addEventListener('click', async () => {
                        const poizonLinkInput = document.getElementById('poizon-link-input');
                        const poizonLink = poizonLinkInput ? poizonLinkInput.value.trim() : '';
                        if (!poizonLink) {
                            showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä Poizon.');
                            return;
                        }

                        const product = await fetchPoizonProduct(poizonLink);
                        if (product) {
                            selectedProduct = { ...product, originalLink: poizonLink };
                            if (selectedProduct.availableSizes && selectedProduct.availableSizes.length > 0) {
                                selectedProduct.selectedSize = selectedProduct.availableSizes[0];
                            } else {
                                selectedProduct.selectedSize = '–ë–µ–∑ —Ä–∞–∑–º–µ—Ä–∞';
                            }
                            console.log("–î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã:", selectedProduct);
                            renderPage('calculateCostProductDetails');
                        }
                    });
                }
            }

            if (pageName === 'calculateCostProductDetails') {
                const sizeSelectionDiv = document.getElementById('size-selection');
                if (sizeSelectionDiv && selectedProduct && selectedProduct.availableSizes) {
                    sizeSelectionDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                    selectedProduct.availableSizes.forEach(size => {
                        const button = document.createElement('button');
                        button.textContent = size;
                        button.classList.add('size-button');
                        if (size === selectedProduct.selectedSize) {
                            button.classList.add('selected');
                        }
                        button.dataset.size = size;
                        button.addEventListener('click', () => {
                            document.querySelectorAll('.size-button').forEach(btn => btn.classList.remove('selected'));
                            button.classList.add('selected');
                            selectedProduct.selectedSize = size;
                            showMessage(`–í—ã–±—Ä–∞–Ω —Ä–∞–∑–º–µ—Ä: EU ${size}`);
                        });
                        sizeSelectionDiv.appendChild(button);
                    });
                }

                const buyButton = document.getElementById('buy-button');
                if (buyButton) {
                    buyButton.addEventListener('click', () => {
                        if (selectedProduct && selectedProduct.selectedSize) {
                            renderPage('orderConfirmation');
                        } else {
                            showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä —Ç–æ–≤–∞—Ä–∞.');
                        }
                    });
                }
            }

            if (pageName === 'orderConfirmation') {
                const placeOrderBtn = document.getElementById('place-order-btn');
                if (placeOrderBtn) {
                    placeOrderBtn.addEventListener('click', async () => {
                        console.log("–ü–æ–ø—ã—Ç–∫–∞ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑...");
                        console.log("Firebase Ready:", isFirebaseReady, "Current User ID:", currentUserId);

                        if (!isFirebaseReady || !currentUserId) {
                            showMessage('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.');
                            console.error('–û—à–∏–±–∫–∞: Firebase –Ω–µ –≥–æ—Ç–æ–≤ –∏–ª–∏ –Ω–µ—Ç UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                            return;
                        }

                        try {
                            const orderData = {
                                userId: currentUserId,
                                productName: selectedProduct.name,
                                productImageUrl: selectedProduct.imageUrl,
                                productOriginalLink: selectedProduct.originalLink,
                                selectedSize: selectedProduct.selectedSize,
                                priceYuan: selectedProduct.priceYuan,
                                totalPriceRub: selectedProduct.estimatedPriceRub,
                                orderDate: new Date().toISOString(),
                                status: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                                deliveryMethod: '–í –º–∞–≥–∞–∑–∏–Ω–µ',
                                deliveryAddress: '–°–µ—Ä–≥–∏–µ–≤ –ü–æ—Å–∞–¥, –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è —É–ª, –¥.20',
                                recipientName: '–ê–Ω–¥—Ä–µ–π –ü–∞—Å–∫–∞–ª–æ–≤',
                                recipientPhone: '+7 (910) 776 11 86',
                                estimatedDuty: selectedProduct.estimatedDuty
                            };
                            console.log("–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", orderData);

                            const ordersCollectionRef = firestore.collection(
                                db,
                                `artifacts/${appId}/users/${currentUserId}/orders`
                            );

                            await firestore.addDoc(ordersCollectionRef, orderData);

                            // ----- –õ–û–ì–ò–ö–ê –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø –ë–ê–õ–õ–û–í –ü–û –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –ü–†–û–ì–†–ê–ú–ú–ï -----
                            if (currentUserProfile && !currentUserProfile.hasMadeFirstOrder) {
                                // –≠—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                const amountForUser = 500; // –ë–∞–ª–ª—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                await updateUserBalance(currentUserId, amountForUser);
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –±–∞–ª–ª—ã –∑–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å
                                const userDocRef = firestore.doc(db, `artifacts/${appId}/users/${currentUserId}`);
                                await firestore.updateDoc(userDocRef, { hasMadeFirstOrder: true });
                                currentUserProfile.hasMadeFirstOrder = true; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ

                                if (currentUserProfile.invitedBy) {
                                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω, –Ω–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É
                                    const referrerId = currentUserProfile.invitedBy;
                                    // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ –ø–æ –µ–≥–æ referralCode
                                    const referrerQuerySnapshot = await firestore.getDocs(
                                        firestore.query(
                                            firestore.collection(db, `artifacts/${appId}/users`),
                                            firestore.where("referralCode", "==", referrerId)
                                        )
                                    );

                                    if (!referrerQuerySnapshot.empty) {
                                        const referrerDoc = referrerQuerySnapshot.docs[0];
                                        const referrerUserId = referrerDoc.id; // –ü–æ–ª—É—á–∞–µ–º UID –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
                                        const amountForReferrer = 500; // –ë–∞–ª–ª—ã –¥–ª—è –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
                                        await updateUserBalance(referrerUserId, amountForReferrer);
                                        showMessage(`–í—ã –∏ –≤–∞—à –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª–∏ –ø–æ ${amountForReferrer} ‚ÇΩ!`);
                                    } else {
                                        console.warn(`–ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∫–æ–¥–æ–º ${referrerId} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
                                        showMessage(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${amountForUser} ‚ÇΩ –∑–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑!`);
                                    }
                                } else {
                                    showMessage(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${amountForUser} ‚ÇΩ –∑–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑!`);
                                }
                            } else {
                                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑, –ø—Ä–æ—Å—Ç–æ —É–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
                                showMessage('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
                            }
                            // ----- –ö–û–ù–ï–¶ –õ–û–ì–ò–ö–ò –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –ü–†–û–ì–†–ê–ú–ú–´ -----

                            console.log('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', orderData);
                            selectedProduct = null;
                            setTimeout(() => renderPage('myOrders'), 1500);

                        } catch (error) {
                            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤ Firestore:', error);
                        }
                    });
                }

                const addPointsBtn = document.getElementById('add-points-btn');
                if (addPointsBtn) {
                    addPointsBtn.addEventListener('click', async () => {
                        if (currentUserId) {
                            await updateUserBalance(currentUserId, 50); // –ù–∞—á–∏—Å–ª–∏—Ç—å 50 –±–∞–ª–ª–æ–≤
                            renderPage('orderConfirmation'); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                        } else {
                            showMessage('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –±–∞–ª–ª–∞–º–∏.');
                        }
                    });
                }

                const subtractPointsBtn = document.getElementById('subtract-points-btn');
                if (subtractPointsBtn) {
                    subtractPointsBtn.addEventListener('click', async () => {
                        if (currentUserId) {
                            if (currentUserProfile && currentUserProfile.balance >= 50) {
                                await updateUserBalance(currentUserId, -50); // –°–ø–∏—Å–∞—Ç—å 50 –±–∞–ª–ª–æ–≤
                                renderPage('orderConfirmation'); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                            } else {
                                showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è.');
                            }
                        } else {
                            showMessage('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –±–∞–ª–ª–∞–º–∏.');
                        }
                    });
                }


                const deliveryMethodButtonsDiv = document.getElementById('delivery-method-selection');
                if (deliveryMethodButtonsDiv) {
                    deliveryMethodButtonsDiv.querySelectorAll('button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            deliveryMethodButtonsDiv.querySelectorAll('button').forEach(btn => {
                                btn.classList.remove('bg-white', 'shadow-sm');
                            });
                            event.target.classList.add('bg-white', 'shadow-sm');
                            showMessage(`–í—ã–±—Ä–∞–Ω —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è: ${event.target.textContent.trim()}`);
                        });
                    });
                }

                const orderSizeSelectionDiv = document.getElementById('order-size-selection');
                if (orderSizeSelectionDiv && selectedProduct && selectedProduct.availableSizes) {
                    orderSizeSelectionDiv.innerHTML = '';
                    selectedProduct.availableSizes.forEach(size => {
                        const button = document.createElement('button');
                        button.textContent = size;
                        button.classList.add('size-button');
                        if (size === selectedProduct.selectedSize) {
                            button.classList.add('selected');
                        }
                        button.dataset.size = size;
                        button.addEventListener('click', () => {
                            orderSizeSelectionDiv.querySelectorAll('.size-button').forEach(btn => btn.classList.remove('selected'));
                            button.classList.add('selected');
                            selectedProduct.selectedSize = size;
                            showMessage(`–í—ã–±—Ä–∞–Ω —Ä–∞–∑–º–µ—Ä: EU ${size}`);
                        });
                        orderSizeSelectionDiv.appendChild(button);
                    });
                }
            }

            if (pageName === 'myOrders') {
                const ordersListDiv = document.getElementById('orders-list');
                if (ordersListDiv) {
                    ordersListDiv.innerHTML = '<p class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>';

                    if (!isFirebaseReady || !currentUserId) {
                        ordersListDiv.innerHTML = '<p class="text-center text-red-500">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω.</p>';
                        console.error('–û—à–∏–±–∫–∞: Firebase –Ω–µ –≥–æ—Ç–æ–≤ –∏–ª–∏ –Ω–µ—Ç UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤.');
                        return;
                    }

                    const userOrdersCollectionRef = firestore.collection(
                        db,
                        `artifacts/${appId}/users/${currentUserId}/orders`
                    );
                    console.log("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã –∏–∑:", `artifacts/${appId}/users/${currentUserId}/orders`);

                    firestore.onSnapshot(userOrdersCollectionRef, (snapshot) => {
                        if (snapshot.empty) {
                            ordersListDiv.innerHTML = '<p class="text-center text-gray-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</p>';
                            console.log("–ó–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.");
                            return;
                        }

                        ordersListDiv.innerHTML = '';
                        snapshot.forEach(doc => {
                            const order = doc.data();
                            const orderId = doc.id;
                            console.log("–ó–∞–≥—Ä—É–∂–µ–Ω –∑–∞–∫–∞–∑:", orderId, order);
                            ordersListDiv.innerHTML += `
                                <div class="bg-white p-4 rounded-xl shadow-sm flex items-center space-x-4">
                                    <img src="${order.productImageUrl || 'https://placehold.co/80x80/CCCCCC/FFFFFF?text=–ù–µ—Ç+—Ñ–æ—Ç–æ'}" alt="${order.productName}" class="w-20 h-20 rounded-lg object-cover">
                                    <div class="flex-grow">
                                        <p class="font-semibold text-lg">${order.productName || '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                        <p class="text-gray-600 text-sm">–†–∞–∑–º–µ—Ä: EU ${order.selectedSize || '–ù–µ –≤—ã–±—Ä–∞–Ω'}</p>
                                        <p class="text-gray-600 text-sm">–°—Ç–∞—Ç—É—Å: <span class="font-medium text-blue-600">${order.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span></p>
                                        <p class="text-gray-800 font-bold mt-1">${order.totalPriceRub ? order.totalPriceRub.toFixed(0) : '0'} ‚ÇΩ</p>
                                        <p class="text-gray-500 text-xs">–ó–∞–∫–∞–∑ –æ—Ç: ${order.orderDate ? new Date(order.orderDate).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                                        <p class="text-gray-500 text-xs">ID –∑–∞–∫–∞–∑–∞: ${orderId}</p>
                                    </div>
                                </div>
                            `;
                        });
                    }, (error) => {
                        console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:", error);
                        ordersListDiv.innerHTML = '<p class="text-center text-red-500">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤.</p>';
                    });
                }
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –°–¢–ê–¢–ò–ß–ï–°–ö–ò–• –∫–Ω–æ–ø–æ–∫ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        document.querySelectorAll('.bottom-nav-item').forEach(button => {
            button.addEventListener('click', () => {
                renderPage(button.dataset.page);
            });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM –∏ Firebase
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase –∏ –∂–¥–µ–º, –ø–æ–∫–∞ currentUserId –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                await initFirebase();

                if (!currentUserId) {
                    console.error("DOMContentLoaded: currentUserId –Ω–µ –±—ã–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ—Å–ª–µ initFirebase. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞.");
                    showMessage('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                    hideLoading();
                    return;
                }

                let invitedByCode = null;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º initDataUnsafe –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å start_param, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.start_param) {
                    invitedByCode = window.Telegram.WebApp.initDataUnsafe.start_param;
                    console.log("DOMContentLoaded: –ü–æ–ª—É—á–µ–Ω start_param:", invitedByCode);
                }

                await getUserProfile(currentUserId, invitedByCode);

                hideLoading();
                renderPage('home');
            } catch (error) {
                console.error("DOMContentLoaded: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:", error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                hideLoading();
            }
        });
    </script>
</body>
</html>
